using System;
using System.Collections.Generic;
using System.Text;
using System.Reflection;
using Fuzzware.Schemer.AutoGenerated;
using Fuzzware.Common;
using Fuzzware.Common.XML;

namespace Fuzzware.Schemer.Fuzzers.NumberFuzzing
{
    abstract class IntegerFuzzerBase : FuzzerBase, ITypeFuzzer
    {
        protected IntegerValueFuzzer ValueConfig;
        protected ObjectDBEntry oSchemaElement;

        public IntegerFuzzerBase(ConfigData oConfigData, PreCompData oPreCompData, ObjectDBEntry oSchemaElement)
            : base(oConfigData, oPreCompData)
        {
            this.oSchemaElement = oSchemaElement;
            ConfigDefinedValues = null;
            ValueConfig = oConfigData.STFConfig.IntegerValueFuzzer;

            bool UsingCustomFuzzer = false;
            if (null != ValueConfig)
            {
                // Check if the user has assigned custom fuzzers for this node
                if (ValueConfig.CustomFuzzer != null)
                    for (int i = 0; i < ValueConfig.CustomFuzzer.Length; i++)
                    {
                        if (ValueConfig.CustomFuzzer[i].NodeNamespace.Equals(oSchemaElement.Name.Namespace, StringComparison.CurrentCultureIgnoreCase) &&
                            ValueConfig.CustomFuzzer[i].NodeName.Equals(oSchemaElement.Name.Name, StringComparison.CurrentCultureIgnoreCase))
                        {
                            AssignValueFuzzers(ValueConfig.CustomFuzzer[i]);
                            UsingCustomFuzzer = true;
                            Log.Write(MethodBase.GetCurrentMethod(), "Custom IntegerValue fuzzer being used", Log.LogType.LogOnlyInfo);
                            break;
                        }
                    }
                // Assign the default fuzzers if there is no custom one
                if (!UsingCustomFuzzer && (ValueConfig.DefaultFuzzers != null))
                    AssignValueFuzzers(ValueConfig.DefaultFuzzers);
            }
        }

        protected abstract string GetFuzzerName();

        protected virtual void AssignValueFuzzers(IntegerValueFuzzersType FuzzersType)
        {
            ValueFuzzerType oValueFuzzerType = FuzzersType.GetType().GetProperty(GetFuzzerName()).GetValue(FuzzersType, null) as ValueFuzzerType;
            if (oValueFuzzerType != null)
            {
                Add(GetFuzzerName(), FuzzConfigDefinedValues);
                ConfigDefinedValues = GetValueGroup(oValueFuzzerType.ValueGroupRef);
            }
        }

        protected string[] GetValueGroup(String ID)
        {
            for (int i = 0; i < ValueConfig.IntegerGroup.Length; i++)
            {
                if (ID == ValueConfig.IntegerGroup[i].ID)
                    return ValueConfig.IntegerGroup[i].IntegerValue;
            }
            Log.Write(MethodBase.GetCurrentMethod(), "Could not find a ValueGroup with ID='" + ID + "'.  '" + GetFuzzerName() + "' will be skipped.", Log.LogType.Warning);
            return null;
        }
    }
}
