using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Text;
using System.Windows;
using Fuzzware.Fuzzsaw.Common;
using Fuzzware.Schemer.AutoGenerated;

namespace Fuzzware.Fuzzsaw.FuzzingConfig.ViewModel
{
    public class IntegerFuzzerViewModel : BaseFuzzerViewModel
    {
        #region Dependency Properties

        static readonly DependencyProperty ReplaceIntegersFuzzDataProperty = DependencyProperty.Register("ReplaceIntegersFuzzData", typeof(FuzzDataSelectorViewModel), typeof(IntegerFuzzerViewModel));
        /// <summary>
        /// ReplaceIntegersFuzzData
        /// </summary>
        public FuzzDataSelectorViewModel ReplaceIntegersFuzzData
        {
            get { return (FuzzDataSelectorViewModel)GetValue(ReplaceIntegersFuzzDataProperty); }
            set { SetValue(ReplaceIntegersFuzzDataProperty, value); }
        }

        static readonly DependencyProperty RandomIntegersFuzzDataProperty = DependencyProperty.Register("RandomIntegersFuzzData", typeof(ObservableString), typeof(IntegerFuzzerViewModel));
        /// <summary>
        /// RandomIntegersFuzzData
        /// </summary>
        public ObservableString RandomIntegersFuzzData
        {
            get { return (ObservableString)GetValue(RandomIntegersFuzzDataProperty); }
            set { SetValue(RandomIntegersFuzzDataProperty, value); }
        }

        static readonly DependencyProperty AddIntegersFuzzDataProperty = DependencyProperty.Register("AddIntegersFuzzData", typeof(FuzzDataSelectorViewModel), typeof(IntegerFuzzerViewModel));
        /// <summary>
        /// AddIntegersFuzzData
        /// </summary>
        public FuzzDataSelectorViewModel AddIntegersFuzzData
        {
            get { return (FuzzDataSelectorViewModel)GetValue(AddIntegersFuzzDataProperty); }
            set { SetValue(AddIntegersFuzzDataProperty, value); }
        }

        static readonly DependencyProperty SubtractIntegersFuzzDataProperty = DependencyProperty.Register("SubtractIntegersFuzzData", typeof(FuzzDataSelectorViewModel), typeof(IntegerFuzzerViewModel));
        /// <summary>
        /// SubtractIntegersFuzzData
        /// </summary>
        public FuzzDataSelectorViewModel SubtractIntegersFuzzData
        {
            get { return (FuzzDataSelectorViewModel)GetValue(SubtractIntegersFuzzDataProperty); }
            set { SetValue(SubtractIntegersFuzzDataProperty, value); }
        }

        static readonly DependencyProperty MultiplyIntegersFuzzDataProperty = DependencyProperty.Register("MultiplyIntegersFuzzData", typeof(FuzzDataSelectorViewModel), typeof(IntegerFuzzerViewModel));
        /// <summary>
        /// MultiplyIntegersFuzzData
        /// </summary>
        public FuzzDataSelectorViewModel MultiplyIntegersFuzzData
        {
            get { return (FuzzDataSelectorViewModel)GetValue(MultiplyIntegersFuzzDataProperty); }
            set { SetValue(MultiplyIntegersFuzzDataProperty, value); }
        }

        static readonly DependencyProperty DivideIntegersFuzzDataProperty = DependencyProperty.Register("DivideIntegersFuzzData", typeof(FuzzDataSelectorViewModel), typeof(IntegerFuzzerViewModel));
        /// <summary>
        /// DivideIntegersFuzzData
        /// </summary>
        public FuzzDataSelectorViewModel DivideIntegersFuzzData
        {
            get { return (FuzzDataSelectorViewModel)GetValue(DivideIntegersFuzzDataProperty); }
            set { SetValue(DivideIntegersFuzzDataProperty, value); }
        }

        #endregion

        #region Validation
        protected string Validate(object oValue)
        {
            if (!(oValue is String))
                return "Invalid Object";

            String strValue = oValue as String;

            if (strValue.Equals(ADD_A_VALUE))
                return null;

            if (String.IsNullOrEmpty(strValue))
                return "Empty values are not allowed";

            Int64 num = 0;
            string error;
            if (!Int64.TryParse(strValue, out num))
            {
                error = "A number is required";
                // See if it is a hex number
                if (strValue.StartsWith("0x", StringComparison.CurrentCultureIgnoreCase))
                {
                    // Read in as a hex number
                    if (Int64.TryParse(strValue.Substring(2, strValue.Length - 2), System.Globalization.NumberStyles.HexNumber, null, out num))
                    {
                        error = null;
                    }
                    else
                        error = "Could not convert what appears to be a hex number";
                }
                return error;
            }

            return null;
        }
        #endregion

        public IntegerFuzzerViewModel() : base()
        {
            m_oValidateValueCallback += Validate;

            ReplaceIntegersFuzzData = new FuzzDataSelectorViewModel();
            ReplaceIntegersFuzzData.ValidateValuesMethod = ValidateValues;
            RandomIntegersFuzzData = new ObservableString("");
            AddIntegersFuzzData = new FuzzDataSelectorViewModel();
            AddIntegersFuzzData.ValidateValuesMethod = ValidateValues;
            SubtractIntegersFuzzData = new FuzzDataSelectorViewModel();
            SubtractIntegersFuzzData.ValidateValuesMethod = ValidateValues;
            MultiplyIntegersFuzzData = new FuzzDataSelectorViewModel();
            MultiplyIntegersFuzzData.ValidateValuesMethod = ValidateValues;
            DivideIntegersFuzzData = new FuzzDataSelectorViewModel();
            DivideIntegersFuzzData.ValidateValuesMethod = ValidateValues;
        }

        private void InitProperties()
        {
            ReplaceIntegersFuzzData.DataCollection.Clear();
            RandomIntegersFuzzData.Value = "";
            AddIntegersFuzzData.DataCollection.Clear();
            SubtractIntegersFuzzData.DataCollection.Clear();
            MultiplyIntegersFuzzData.DataCollection.Clear();
            DivideIntegersFuzzData.DataCollection.Clear();
        }

        protected void PopulateFuzzData(SimpleTypeFuzzerConfig oSTFC, IntegerValueFuzzersType oIVFT)
        {
            // Always call populate so we add the final value to the collections that allows us to add new values
            PopulateValueFuzzData((null != oIVFT) ? oIVFT.ReplaceInteger : null, oSTFC.IntegerValueFuzzer, ReplaceIntegersFuzzData.DataCollection, GetRefName(ReplaceIntegersFuzzDataProperty));
            if ((null != oIVFT) && (null != oIVFT.RandomInteger))
                RandomIntegersFuzzData = new ObservableString(oIVFT.RandomInteger.Iterations.ToString());
            PopulateValueFuzzData((null != oIVFT) ? oIVFT.AddInteger : null, oSTFC.IntegerValueFuzzer, AddIntegersFuzzData.DataCollection, GetRefName(AddIntegersFuzzDataProperty));
            PopulateValueFuzzData((null != oIVFT) ? oIVFT.SubtractInteger : null, oSTFC.IntegerValueFuzzer, SubtractIntegersFuzzData.DataCollection, GetRefName(SubtractIntegersFuzzDataProperty));
            PopulateValueFuzzData((null != oIVFT) ? oIVFT.MultiplyInteger : null, oSTFC.IntegerValueFuzzer, MultiplyIntegersFuzzData.DataCollection, GetRefName(MultiplyIntegersFuzzDataProperty));
            PopulateValueFuzzData((null != oIVFT) ? oIVFT.DivideInteger : null, oSTFC.IntegerValueFuzzer, DivideIntegersFuzzData.DataCollection, GetRefName(DivideIntegersFuzzDataProperty));
        }

        /// <summary>
        /// Initialisation for the default integer fuzzer
        /// </summary>
        public void InitialiseData(SimpleTypeFuzzerConfig oSTFC, IntegerValueFuzzersType oIVFT)
        {
            InitProperties();

            DefaultFuzzer = true;
            OnOffControl.On = true;
            CustomFuzzer = false;

            // For the default fuzzer, if there are no fuzzers configured, then disable config
            if ((null != oIVFT) &&
                (null == oIVFT.ReplaceInteger) &&
                (null == oIVFT.RandomInteger) &&
                (null == oIVFT.AddInteger) &&
                (null == oIVFT.SubtractInteger) &&
                (null == oIVFT.MultiplyInteger) &&
                (null == oIVFT.DivideInteger))
            {
                OnOffControl.On = false;
            }

            PopulateFuzzData(oSTFC, oIVFT);
        }

        /// <summary>
        /// The constructor for the custom string fuzzer
        /// </summary>
        public IntegerFuzzerViewModel(SimpleTypeFuzzerConfig oSTFC, IntegerValueFuzzerCustomFuzzer oIVFCF) : this()
        {
            DefaultFuzzer = false;
            // OnOffControl.On is always true for custom fuzzers
            OnOffControl.On = true;
            CustomFuzzer = true;

            PopulateFuzzData(oSTFC, oIVFCF as IntegerValueFuzzersType);

            if (null != oIVFCF)
            {
                CustomNodeNamespace = new ObservableString(oIVFCF.NodeNamespace);
                CustomNodeName = new ObservableString(oIVFCF.NodeName);
            }
        }

        /// <summary>
        /// Populate the view model with value fuzzing data
        /// </summary>
        private void PopulateValueFuzzData(ValueFuzzerType oFuzzerType, IntegerValueFuzzer oIVF, ObservableCollection<ObservableString> BindableData, String DefaultGroupRef)
        {
            String ValueGroupRef = null;
            if ((null != oFuzzerType) && (null != oIVF))
            {
                ValueGroupRef = oFuzzerType.ValueGroupRef;
            }
            else if(DefaultFuzzer && !OnOffControl.On && (null != oIVF))
            {
                ValueGroupRef = DefaultGroupRef;
            }
            if (!String.IsNullOrEmpty(ValueGroupRef))
            {
                IntegerValueFuzzerIntegerGroup oIVFIG = FindStringValueGroup(ValueGroupRef, oIVF.IntegerGroup);
                if (null != oIVFIG)
                    CopyFuzzData(oIVFIG.IntegerValue, BindableData);
            }
            // Always make sure the last item is the option to add a new value
            BindableData.Add(new ObservableString(ADD_A_VALUE));
        }

        /// <summary>
        /// Find the integer value fuzz data
        /// </summary>
        private IntegerValueFuzzerIntegerGroup FindStringValueGroup(String Name, IntegerValueFuzzerIntegerGroup[] oIVFIG)
        {
            if (null != oIVFIG)
            {
                for (int i = 0; i < oIVFIG.Length; i++)
                {
                    if (oIVFIG[i].ID.Equals(Name))
                        return oIVFIG[i];
                }
            }
            return null;
        }

        /// <summary>
        /// Update the current Integer types view to its original data source
        /// </summary>
        public void UpdateIntegerTypeConfig(SimpleTypeFuzzerConfig oSTFC)
        {
            if (null == oSTFC.IntegerValueFuzzer)
                oSTFC.IntegerValueFuzzer = new IntegerValueFuzzer();

            // Save the default string fuzzers
            IntegerValueFuzzer oIVF = oSTFC.IntegerValueFuzzer;
            // Create the string length fuzzers
            IntegerValueFuzzersType oIVFT = CreateIntegerValueFuzzersType();
            oIVFT.ReplaceInteger = CreateValueFuzzerType(ReplaceIntegersFuzzData.DataCollection, GetRefName(ReplaceIntegersFuzzDataProperty), null, null);
            oIVFT.RandomInteger = CreateRandomFuzzerType(RandomIntegersFuzzData);
            oIVFT.AddInteger = CreateValueFuzzerType(AddIntegersFuzzData.DataCollection, GetRefName(AddIntegersFuzzDataProperty), null, null);
            oIVFT.SubtractInteger = CreateValueFuzzerType(SubtractIntegersFuzzData.DataCollection, GetRefName(SubtractIntegersFuzzDataProperty), null, null);
            oIVFT.MultiplyInteger = CreateValueFuzzerType(MultiplyIntegersFuzzData.DataCollection, GetRefName(MultiplyIntegersFuzzDataProperty), null, null);
            oIVFT.DivideInteger = CreateValueFuzzerType(DivideIntegersFuzzData.DataCollection, GetRefName(DivideIntegersFuzzDataProperty), null, null);
            // Add the fuzzers as either the default or a custom
            if (DefaultFuzzer)
                oIVF.DefaultFuzzers = oIVFT;
            else
            {
                List<IntegerValueFuzzerCustomFuzzer> oIVFCFList = new List<IntegerValueFuzzerCustomFuzzer>(oIVF.CustomFuzzer);
                oIVFCFList.Add(oIVFT as IntegerValueFuzzerCustomFuzzer);
                oIVF.CustomFuzzer = oIVFCFList.ToArray();
            }
            // Create the string value fuzzer value groups
            List<IntegerValueFuzzerIntegerGroup> oIntegerGroups = new List<IntegerValueFuzzerIntegerGroup>(oIVF.IntegerGroup);
            IntegerValueFuzzerIntegerGroup oIVFIG = new IntegerValueFuzzerIntegerGroup();
            // Add the ValueGroups, always add the default ones, even if no fuzzers were being used
            if ((null != oIVFT.ReplaceInteger) || DefaultFuzzer)
            {
                oIVFIG.ID = DefaultFuzzer ? GetRefName(ReplaceIntegersFuzzDataProperty) : oIVFT.ReplaceInteger.ValueGroupRef;
                oIVFIG.IntegerValue = GetStringArray(ReplaceIntegersFuzzData.DataCollection);
                oIntegerGroups.Add(oIVFIG);
            }
            if ((null != oIVFT.AddInteger) || DefaultFuzzer)
            {
                oIVFIG = new IntegerValueFuzzerIntegerGroup();
                oIVFIG.ID = DefaultFuzzer ? GetRefName(AddIntegersFuzzDataProperty) : oIVFT.AddInteger.ValueGroupRef;
                oIVFIG.IntegerValue = GetStringArray(AddIntegersFuzzData.DataCollection);
                oIntegerGroups.Add(oIVFIG);
            }
            if ((null != oIVFT.SubtractInteger) || DefaultFuzzer)
            {
                oIVFIG = new IntegerValueFuzzerIntegerGroup();
                oIVFIG.ID = DefaultFuzzer ? GetRefName(SubtractIntegersFuzzDataProperty) : oIVFT.SubtractInteger.ValueGroupRef;
                oIVFIG.IntegerValue = GetStringArray(SubtractIntegersFuzzData.DataCollection);
                oIntegerGroups.Add(oIVFIG);
            }
            if ((null != oIVFT.MultiplyInteger) || DefaultFuzzer)
            {
                oIVFIG = new IntegerValueFuzzerIntegerGroup();
                oIVFIG.ID = DefaultFuzzer ? GetRefName(MultiplyIntegersFuzzDataProperty) : oIVFT.MultiplyInteger.ValueGroupRef;
                oIVFIG.IntegerValue = GetStringArray(MultiplyIntegersFuzzData.DataCollection);
                oIntegerGroups.Add(oIVFIG);
            }
            if ((null != oIVFT.DivideInteger) || DefaultFuzzer)
            {
                oIVFIG = new IntegerValueFuzzerIntegerGroup();
                oIVFIG.ID = DefaultFuzzer ? GetRefName(DivideIntegersFuzzDataProperty) : oIVFT.DivideInteger.ValueGroupRef;
                oIVFIG.IntegerValue = GetStringArray(DivideIntegersFuzzData.DataCollection);
                oIntegerGroups.Add(oIVFIG);
            }
            oIVF.IntegerGroup = oIntegerGroups.ToArray();
        }

        /// <summary>
        /// If default return a IntegerValueFuzzersType, if not default return IntegerValueFuzzerCustomFuzzer and populate
        /// node name and namespace.  If not default and no name and namespace, return null.
        /// </summary>
        protected IntegerValueFuzzersType CreateIntegerValueFuzzersType()
        {
            if (DefaultFuzzer)
                return new IntegerValueFuzzersType();
            else
            {
                if (String.IsNullOrEmpty(CustomNodeName.Value) && String.IsNullOrEmpty(CustomNodeNamespace.Value))
                    return null;

                IntegerValueFuzzerCustomFuzzer oSLFCF = new IntegerValueFuzzerCustomFuzzer();
                oSLFCF.NodeName = CustomNodeName.Value;
                oSLFCF.NodeNamespace = CustomNodeNamespace.Value;
                return oSLFCF as IntegerValueFuzzersType;
            }
        }
    }
}
